{% extends "base.html" %}
{% block title %}推荐 - 电影推荐系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1">推荐</h4>
        {% if personalized %}
        <p class="text-muted mb-0">基于你的收藏/评分生成的个性化推荐。<span class="text-secondary small">（类型/演员匹配）</span></p>
        {% else %}
        <p class="text-muted mb-0">当前为高分推荐，登录并收藏/评分后可个性化。</p>
        {% endif %}
    </div>
    <a class="btn btn-outline-dark" href="{% url 'movie_list' %}">去影片库</a>
</div>

<!-- 个性化推荐区域 -->
<div class="mb-5">
    <div class="row g-3">
        {% for m in recs %}
        <div class="col-6 col-md-3">
            <a class="card card-movie glass h-100 text-decoration-none text-dark" href="{% url 'movie_detail' m.pk %}">
                <div class="ratio ratio-2x3">
                    <img src="{{ m.poster|default:'' }}" class="card-img-top rounded-top-3 object-fit-cover" alt="{{ m.title }}" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'placeholder rounded-3 w-100 h-100\'></div>';">
                </div>
                <div class="card-body">
                    <h6 class="card-title text-truncate mb-1">{{ m.title }}</h6>
                    <p class="text-muted small mb-1 text-truncate">{{ m.region }} · {{ m.type }}</p>
                    <span class="badge bg-dark rounded-pill">评分 {{ m.score|default:"-" }}</span>
                </div>
            </a>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="glass p-4 rounded-4 text-center">
                <p class="text-muted mb-0">暂无推荐数据</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- AI推荐区域 -->
<div class="ai-recommend-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-1">AI 智能推荐</h4>
            <p class="text-muted mb-0 small">基于深度学习的个性化推荐算法</p>
        </div>
        <button class="btn btn-dark" id="btn-ai-recommend" disabled>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="btn-text">生成推荐</span>
        </button>
    </div>
    
    <div class="glass p-4 rounded-4 ai-recommend-container">
        <div id="ai-recommend-placeholder" class="text-center py-5">
            <div class="mb-3">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-muted">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
            </div>
            <p class="text-muted mb-2">AI 推荐功能</p>
            <p class="text-muted small">点击上方按钮生成个性化推荐</p>
        </div>
        
        <div id="ai-recommend-results" class="d-none">
            <div class="row g-3" id="ai-movies-list">
                <!-- AI推荐的电影将在这里动态加载 -->
            </div>
        </div>
        
        <div id="ai-recommend-loading" class="d-none text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="text-muted">AI 正在分析你的观影偏好...</p>
        </div>
        
        <div id="ai-recommend-error" class="d-none text-center py-5">
            <div class="alert alert-warning mb-0">
                <p class="mb-0">推荐生成失败，请稍后重试</p>
            </div>
            <button class="btn btn-sm btn-outline-dark mt-3" onclick="location.reload()">刷新重试</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // AI推荐功能
    const aiRecommendBtn = document.getElementById('btn-ai-recommend');
    const placeholder = document.getElementById('ai-recommend-placeholder');
    const results = document.getElementById('ai-recommend-results');
    const loading = document.getElementById('ai-recommend-loading');
    const error = document.getElementById('ai-recommend-error');
    const aiMoviesList = document.getElementById('ai-movies-list');
    const csrftoken = getCookie('csrftoken');
    
    // 检查用户是否登录
    {% if user.is_authenticated %}
    if (aiRecommendBtn) {
        aiRecommendBtn.disabled = false;
        aiRecommendBtn.addEventListener('click', async function() {
            // 显示加载状态
            placeholder.classList.add('d-none');
            results.classList.add('d-none');
            error.classList.add('d-none');
            loading.classList.remove('d-none');
            aiRecommendBtn.disabled = true;
            aiRecommendBtn.querySelector('.btn-text').textContent = '生成中...';
            
            try {
                const response = await fetch('{% url "ai_recommend_api" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                // 无论成功与否，都尝试显示结果（可能包含原始回答）
                if (data.raw_ai_response || data.recommendations) {
                    // 显示推荐结果（可能包含原始回答）
                    displayRecommendations(data);
                } else {
                    // 显示错误
                    const errorMsg = data.message || data.error || '推荐生成失败，请稍后重试';
                    error.querySelector('.alert p').textContent = errorMsg;
                    error.classList.remove('d-none');
                }
            } catch (err) {
                console.error('AI推荐错误:', err);
                error.querySelector('.alert p').textContent = '网络错误，请稍后重试';
                error.classList.remove('d-none');
            } finally {
                loading.classList.add('d-none');
                aiRecommendBtn.disabled = false;
                aiRecommendBtn.querySelector('.btn-text').textContent = '生成推荐';
            }
        });
    }
    
    function displayRecommendations(data) {
        // 清空之前的内容
        const existingAnalysis = results.querySelector('.ai-analysis-section');
        const existingRawResponse = results.querySelector('.ai-raw-response-section');
        if (existingAnalysis) existingAnalysis.remove();
        if (existingRawResponse) existingRawResponse.remove();
        aiMoviesList.innerHTML = '';
        
        // 显示AI分析结果
        if (data.analysis) {
            const analysisDiv = document.createElement('div');
            analysisDiv.className = 'ai-analysis-section mb-4 p-3 bg-light rounded';
            analysisDiv.innerHTML = `
                <p class="mb-0 text-muted">
                    <strong>AI分析：</strong>${data.analysis}
                </p>
            `;
            results.insertBefore(analysisDiv, aiMoviesList);
        }
        
        // 显示原始AI回答（展示工作量）
        if (data.raw_ai_response) {
            const rawResponseDiv = document.createElement('div');
            rawResponseDiv.className = 'ai-raw-response-section mb-4';
            rawResponseDiv.innerHTML = `
                <div class="card glass">
                    <div class="card-header bg-transparent border-0 pb-2">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawResponseCollapse" aria-expanded="false">
                            <span>查看AI原始回答</span>
                            <span class="ms-1">▼</span>
                        </button>
                    </div>
                    <div class="collapse" id="rawResponseCollapse">
                        <div class="card-body">
                            <pre class="mb-0 text-muted small" style="white-space: pre-wrap; font-family: 'SF Pro Text', -apple-system, sans-serif; font-size: 0.85rem; line-height: 1.5;">${escapeHtml(data.raw_ai_response)}</pre>
                        </div>
                    </div>
                </div>
            `;
            results.insertBefore(rawResponseDiv, aiMoviesList);
        }
        
        // 显示推荐电影
        if (data.recommendations && data.recommendations.length > 0) {
            data.recommendations.forEach(movie => {
                const colDiv = document.createElement('div');
                colDiv.className = 'col-6 col-md-3';
                
                // 如果有ID则链接到详情页，否则只显示信息
                const movieUrl = movie.id ? `/movies/${movie.id}/` : '#';
                const movieLinkClass = movie.id ? 'text-decoration-none text-dark' : 'text-decoration-none text-dark disabled';
                
                const movieCard = `
                    <div class="card card-movie glass h-100">
                        ${movie.id ? `<a href="${movieUrl}" class="${movieLinkClass}">` : '<div>'}
                        <div class="ratio ratio-2x3">
                            ${movie.poster ? 
                                `<img src="${movie.poster}" class="card-img-top rounded-top-3 object-fit-cover" alt="${movie.title}" 
                                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'placeholder rounded-3 w-100 h-100\'></div>';">` :
                                `<div class="placeholder rounded-top-3 w-100 h-100 d-flex align-items-center justify-content-center">
                                    <span class="text-muted small">暂无海报</span>
                                </div>`
                            }
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-truncate mb-1">${movie.title}</h6>
                            <p class="text-muted small mb-1 text-truncate">${movie.region || '未知'} · ${movie.type || '未知'}</p>
                            <span class="badge bg-dark rounded-pill mb-2">评分 ${movie.score || '-'}</span>
                            <p class="text-muted small mb-0" style="font-size: 0.75rem;">${movie.reason || ''}</p>
                        </div>
                        ${movie.id ? '</a>' : '</div>'}
                    </div>
                `;
                colDiv.innerHTML = movieCard;
                aiMoviesList.appendChild(colDiv);
            });
            
            results.classList.remove('d-none');
        } else {
            // 即使没找到匹配电影，也显示原始回答
            if (data.raw_ai_response) {
                results.classList.remove('d-none');
            } else {
                error.querySelector('.alert p').textContent = data.message || '未找到推荐电影';
                error.classList.remove('d-none');
            }
        }
    }
    
    // HTML转义函数
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    {% else %}
    // 未登录用户
    if (aiRecommendBtn) {
        aiRecommendBtn.addEventListener('click', function() {
            window.location.href = '{% url "login" %}';
        });
    }
    {% endif %}
</script>
{% endblock %}

